<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Experimental IRC chat client</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <link rel="stylesheet" type="text/css" href="jqueryui/default/default.css" />
    <script type="text/javascript" src="jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="config.js"></script>
    <script type="text/javascript">
        $(function () {
            var validateNick = function (nick) {
                return /^\S+$/.test(nick);
            };
            
            var validateServer = function (server) {
                return server.length <= 255 &&
                    /^[a-z][a-z0-9\.-]*$/i.test(server);
            };
            
            var validatePort = function (port) {
                return parseInt(port) > 0;
            };
            
            var validateChannel = function (channel) {
                return /^[#&+!]?[^\s:\cg]+(,[#&+!]?[^\s:\cg]+)*$/.test(channel);
            };
            
            var validateLaunch = function () {
                var channel = $('#channelTextbox').val();
                if (validateNick($('#nickTextbox').val()) &&
                    validateServer($('#serverTextbox').val()) &&
                    validatePort($('#portTextbox').val()) &&
                    (channel == '' || validateChannel(channel)))
                    $('#launchButton').removeAttr('disabled');
                else
                    $('#launchButton').attr('disabled', 'disabled');
            };
            
            $('#nickTextbox')
                .keypress(function (e) {
                    validateLaunch();
                    var newNick = $('#nickTextbox').val() + String.fromCharCode(e.charCode);
                    if (!validateNick(newNick)) return false;
                })
                .blur(function () {
                    var nick = $('#nickTextbox').val();
                    if (validateNick(nick)) {
                        $('#nickLabel').removeClass('ui-state-error');
                        if (window.console) console.log('valid nick');
                    }
                    else {
                        $('#nickLabel').addClass('ui-state-error');
                        if (window.console) console.log('Invalid nick!');
                    }
                });

            $('#serverTextbox')
                .keypress(function (e) {
                    // http://en.wikipedia.org/wiki/Hostname#Restrictions_on_valid_host_names
                    var newServer = $('#serverTextbox').val() + String.fromCharCode(e.charCode);
                    if (!validateServer(newServer)) return false;

                    validateLaunch();
                })
                .blur(function () {
                    var server = $('#serverTextbox').val();
                    if (validateServer(server)) {
                        $('#serverLabel').removeClass('ui-state-error');
                    }
                    else {
                        $('#serverLabel').addClass('ui-state-error');
                    }
                });

            $('#portTextbox')
                .keypress(function (e) {
                    var newPort = $('#portTextbox').val() + String.fromCharCode(e.charCode);
                    if (!validatePort(newPort)) return false;

                    validateLaunch();
                })
                .blur(function () {
                    var port = $('#portTextbox').val();
                    if (validatePort(port)) {
                        $('#portLabel').removeClass('ui-state-error');
                    }
                    else {
                        $('#portLabel').addClass('ui-state-error');
                    }
                });
                
            $('#channelTextbox')
                .keypress(function (e) {
                    // Block spaces.
                    if (/^\s$/.test(String.fromCharCode(e.charCode))) return false;

                    validateLaunch();
                })
                .change(function () {
                    var channel = $('#channelTextbox').val();
                    if (validateChannel(channel)) {
                        // Automatically prepend channels with '#'.
                        var channels = channel.split(',');

                        // Remove empty array elements.
                        channels = $.grep(channels, function (c) { return !/^#?$/.test(c); });

                        $.each(channels, function (idx, c) {
                            if (/^[^#&+!]/.test(c)) {
                                channels[idx] = '#' + c;
                            }
                        });
                        
                        // Update form action URL.
                        var channel = channels.join(',');
                        $('#channelTextbox').val(channel);

                        // Must clone form to change action URL.
                        // Changing action attribute directly does not work in Safari.
                        $(document.form1).replaceWith($(document.form1)
                            .clone(true)
                            .attr('action', 'client.php' + channel)
                        );
                    }
                })
                .blur(function () {
                    var channel = $('#channelTextbox').val();
                    if (validateChannel(channel)) {
                        $('#channelLabel').removeClass('ui-state-error');
                    }
                    else {
                        $('#channelLabel').addClass('ui-state-error');
                    }
                });

            // Apply default values.
            $('#serverTextbox').val(chatmoreDefaults.server);
            $('#portTextbox').val(chatmoreDefaults.port);
            $('#channelTextbox').val(chatmoreDefaults.channel);
            $('#viewKey').val(Math.random().toString(36).substring(10));
            validateLaunch();
        });
    </script>
</head>
<body>
    <form action="client.php" name="form1" method="GET">
        <input type="hidden" id="viewKey" name="viewKey" />
        <div class="chatmore ui-widget" style="float:left;overflow:hidden">
            <div class="launcher ui-widget-content ui-corner-all">
            <table>
                <col width="150" />
                <col width="*" />
                <tr><th id="nickLabel" class="left">Nickname:</th><td><input type="text" id="nickTextbox" name="nick" /></td></tr>
                <tr><th class="left">Real name:</th><td><input type="text" name="realname" /></td></tr>
                <tr><th id="serverLabel" class="left">Server:</th><td><input type="text" id="serverTextbox" name="server" /></td></tr>
                <tr><th id="portLabel" class="left">Port:</th><td><input type="text" id="portTextbox" name="port" /></td></tr>
                <tr><th id="channelLabel" class="left wrap">Channel:<br/><span class="helpText">Can provide multiple channels separated by commas.</span></th><td><input type="text" id="channelTextbox" /></td></tr>
                <tr><td colspan="2" style="text-align:right"><input type="submit" id="launchButton" disabled="disabled" value="Launch IRC Session" /></td></tr>
            </table>
            </div>
        </div>
        
    </form>
</body>
</html>
