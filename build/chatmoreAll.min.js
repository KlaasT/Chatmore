function chatmoreState(){var h=this;var f=0;var b=31;var e=function(l,k){if(k===undefined){k=2166136261}for(var j=0;j<l.length;j++){k*=16777619;k^=l.charCodeAt(j);k&=4294967295}return k};var d=function(i){for(var j in i){if(i.hasOwnProperty(j)){return false}}return true};h.isModified=false;h.isActivated=false;h.isRegistered=false;h.registrationAttemptCount=0;h.nick=undefined;h.ident=undefined;h.realname=undefined;h.channels={};h.users={};h.lastRecvTime=undefined;h.messageCount=0;h.sessionId=undefined;h.getChannels=function(){var i=[];for(var j in h.channels){i.push(j)}return i};h.getUsers=function(){var j=[];for(var i in h.users){j.push(i)}return j};h.addChannel=function(i){if(h.channels[i]===undefined){h.channels[i]=new g();h.isModified=true}return h.channels[i]};h.addUser=function(i){if(h.users[i]===undefined){h.users[i]=new a();h.isModified=true}return h.users[i]};h.removeChannel=function(i){if(h.channels[i]!==undefined){delete h.channels[i];h.isModified=true}};h.removeUser=function(i){if(h.users[i]!==undefined){delete h.users[i];h.isModified=true}};h.clearChannels=function(){if(!d(h.channels)){h.channels={};h.isModified=true}};h.clearUsers=function(){if(!d(h.users)){h.users={};h.isModified=true}};function g(){this.mode=undefined;this.visibility=undefined;this.topic=undefined;this.topicSetByNick=undefined;this.topicSetTime=undefined;this.members={};this.lastRPL_NAMREPLY=0;this.lastRPL_ENDOFNAMES=0;this.addMember=function(i){if(this.members[i]===undefined){member=new c();member.mode="";nickHash=e(i);member.colorizeNumber=nickHash%(b-f+1)+f;this.members[i]=member;h.isModified=true}return this.members[i]};this.removeMember=function(i){if(this.members[i]!==undefined){delete this.members[i];h.isModified=true}};this.clearMembers=function(){if(!d(this.members)){this.members={};h.isModified=true}}}function c(){this.mode=undefined;this.colorizeNumber=undefined}function a(){this.realname=undefined;this.host=undefined;this.mode=undefined}};function chatmore(d,b){if(b===undefined){b={}}var a=this;var c;c={pollHandle:undefined,pollXhr:undefined,pauseRecv:false,processMessages:function(e){if(e===undefined){return false}a.state.lastRecvTime=new Date().getTime();$.each(e,function(f,h){$(d).trigger("processingMessage.chatmore",[h]);a.state.messageCount++;switch(h.type){case"recv":if(window.console){if(h.raw!==undefined){console.log(h.raw)}console.log(h)}switch(h.command){case"JOIN":if(a.state.channels[h.info.channel]===undefined){a.state.addChannel(h.info.channel);a.sendMsg("MODE "+h.info.channel)}a.state.channels[h.info.channel].addMember(h.prefixNick);break;case"PART":if(a.stricmp(h.prefixNick,a.state.nick)===0){a.state.removeChannel(h.info.channel)}else{a.state.channels[h.info.channel].removeMember(h.prefixNick)}break;case"KICK":$.each(h.info.kicks,function(j,k){if(a.stricmp(k.nick,a.state.nick)===0){a.state.removeChannel(k.channel)}else{a.state.channels[k.channel].removeMember(k.nick)}});break;case"MODE":if(a.isChannel(h.info.target)){if(a.state.channels[h.info.target]!==undefined){a.sendMsg("MODE "+h.info.target);a.sendMsg("NAMES "+h.info.target)}}else{a.state.addUser(h.info.target);a.state.users[h.info.target].mode=h.info.mode;a.state.isModified=true}break;case"NICK":if(a.stricmp(h.prefixNick,a.state.nick)===0){a.state.nick=h.info.nick}a.renameNick(h.info.oldNick,h.info.nick);break;case"QUIT":$.each(a.state.channels,function(j,k){k.removeMember(h.prefixNick)});a.state.removeUser(h.prefixNick);break;case"001":if(!a.state.isRegistered){a.state.isRegistered=true;a.state.isModified=true}break;case"324":if(a.state.channels[h.info.channel]!==undefined){a.state.channels[h.info.channel].mode=h.info.mode;a.state.isModified=true}break;case"331":if(a.state.channels[h.info.channel]!==undefined){a.state.channels[h.info.channel].topic=undefined;a.state.isModified=true}break;case"332":if(a.state.channels[h.info.channel]!==undefined){a.state.channels[h.info.channel].topic=(h.info.topic!=="")?h.info.topic:undefined;a.state.isModified=true}break;case"333":if(a.state.channels[h.info.channel]!==undefined){a.state.channels[h.info.channel].topicSetByNick=h.info.nick;a.state.channels[h.info.channel].topicSetTime=h.info.time;a.state.isModified=true}break;case"403":a.state.removeChannel(h.info.channel);break;case"353":var g=a.state.addChannel(h.info.channel);g.visibility=h.info.visibility;if(g.lastRPL_NAMREPLY<g.lastRPL_ENDOFNAMES){g.clearMembers()}$.each(h.info.names,function(k,j){a.state.addUser(j.nick);memberDesc=g.addMember(j.nick);memberDesc.mode=j.mode});g.lastRPL_NAMREPLY=a.state.messageCount;a.state.isModified=true;break;case"366":if(a.state.channels[h.info.channel]!==undefined){a.state.channels[h.info.channel].lastRPL_ENDOFNAMES=a.state.messageCount}break;case"433":if(!a.state.isRegistered){if(a.state.registrationAttemptCount<a.options.maxRegistrationAttempts){if(a.state.baseNick===undefined){a.state.baseNick=a.state.nick}a.state.nick=""+a.state.baseNick+"_"+a.state.registrationAttemptCount;a.state.registrationAttemptCount++;a.state.isModified=true;$(d).trigger("localMessage.chatmore",[null,"clientMsg",{code:"R1"}]);a.sendMsg("NICK "+a.state.nick)}else{$(d).trigger("localMessage.chatmore",[null,"error",{code:"RE1",maxRegistrationAttempts:a.options.maxRegistrationAttempts}])}}break}break;case"servermsg":if(window.console){if(h.message!==undefined){console.log("servermsg: "+h.code+" "+h.message)}else{console.log("servermsg: "+h.code)}}if(h.code>=400){if(a.state.isActivated&&h.code===400){a.deactivateClient()}}break}$(d).trigger("processedMessage.chatmore",[h]);if(a.state.isModified){$(d).trigger("stateChanged.chatmore");a.state.isModified=false}})}};a.options=$.extend({maxRegistrationAttempts:3,maxResendAttempts:4,pollIntervalDelayMs:100},b);a.state=new chatmoreState();a.state.server=b.server;a.state.port=b.port;a.state.nick=b.nick;a.state.realname=b.realname;a.state.isModified=true;a.target=function(e){if(e===undefined){return c.target}else{if(e===null){e=undefined}c.target=e}};a.activateClient=function(){a.state.isActivated=false;a.state.lastRecvTime=undefined;$(d).trigger("activatingClient.chatmore",["start",undefined,{server:a.state.server,port:a.state.port}]);var h=true;var g=false;var f=function(i){$(d).trigger("activatingClient.chatmore",["error",i,{server:a.state.server,port:a.state.port}])};var e=function(k,i,j){f("Error during activation: "+i+", "+j);g=true};$.ajax("init.php",{async:false,type:"POST",cache:false,dataType:"json",data:{connect:0,viewKey:b.viewKey,server:a.state.server,port:a.state.port},success:function(i){try{c.processMessages.call(a,i);$.each(i,function(k,l){if(l.type==="servermsg"){if(l.code===200){h=false}else{if(l.code>400){f(l.message);g=true}}}})}catch(j){if(window.console){console.error("Exception caught while processing messages:");console.error(i);console.error(j)}}},error:e});if(g){return}if(h){$(d).trigger("activatingClient.chatmore",["connecting",undefined,{server:a.state.server,port:a.state.port}])}else{$(d).trigger("activatingClient.chatmore",["resuming",undefined,{server:a.state.server,port:a.state.port}])}$.ajax("init.php",{type:"POST",cache:false,dataType:"json",data:{connect:1,viewKey:b.viewKey},success:function(j){try{c.processMessages.call(a,j);if($.grep(j,function(l){return l.type==="servermsg"&&l.code===200}).length){$(d).trigger("activatingClient.chatmore",["activated",undefined,{server:a.state.server,port:a.state.port}]);a.state.isActivated=true;if(h){a.register(a.state.nick,a.state.realname)}var i=function(){if(c.pauseRecv){setTimeout(i,100)}else{c.pollHandle=undefined;c.pollXhr=$.ajax("recv.php",{cache:false,data:{viewKey:b.viewKey},dataType:"json",success:function(l){if(typeof(l)==="object"){try{c.processMessages.call(a,l)}catch(m){if(window.console){console.error("Exception caught while processing messages:");console.error(l);console.error(m)}}}else{if(window.console){console.warn("Got invalid data:");console.warn(l)}}},complete:function(){c.pollXhr=undefined;if(a.state.isActivated){c.pollHandle=setTimeout(i,a.options.pollIntervalDelayMs)}}})}};setTimeout(i,0);$(d).trigger("activatedClient.chatmore",[{server:a.state.server,port:a.state.port}])}else{$(d).trigger("activatingClient.chatmore",["error","Error during activation",{server:a.state.server,port:a.state.port}])}}catch(k){if(window.console){console.error("Exception caught while processing messages:");console.error(j);console.error(k)}}},error:e})};a.deactivateClient=function(){if(a.state.isActivated){$(d).trigger("deactivatingClient.chatmore");a.state.isActivated=false;if(c.pollHandle!==undefined){clearTimeout(c.pollHandle)}c.pollHandle=undefined;if(c.pollXhr!==undefined){c.pollXhr.abort()}c.pollXhr=undefined;$(d).trigger("deactivatedClient.chatmore")}};a.sendMsg=function(f,g){var e=function(i){var h=function(){if(i<a.options.maxResendAttempts){if(window.console){console.warn("Resending: "+f)}var j=i>0?3000:100;setTimeout(function(){e(i+1)},j)}};$(d).trigger("sendingMessage.chatmore",[f,i]);$.ajax("send.php",{async:true,type:"POST",dataType:"json",cache:false,data:{viewKey:b.viewKey,msg:f},success:function(j){if(g){g(f)}$(d).trigger("sentMessage.chatmore",[f,i]);if(typeof(j)==="object"){try{c.processMessages.call(a,j)}catch(k){if(window.console){console.error("Exception caught while processing messages:");console.error(j);console.error(k)}}}else{if(window.console){console.warn("Got invalid data:");console.warn(j)}h();return false}},error:function(j,k){$(d).trigger("errorSendingMessage.chatmore",[k,f,i]);h()}})};e(0)};a.register=function(e,f){a.state.nick=e;a.state.ident=Math.floor(Math.random()*100000000);a.state.realname=f;a.state.isRegistered=false;a.state.registrationAttemptCount=1;a.state.isModified=true;if(window.console){console.log('Registering user "'+a.state.nick+'" ('+a.state.realname+') on IRC server "'+a.state.server+":"+a.state.port+'"')}a.sendMsg("USER "+a.state.ident+" 0 * :"+a.state.realname);a.sendMsg("NICK "+a.state.nick)};a.sendChannelMsg=function(f,e){this.sendMsg("PRIVMSG "+f+" :"+e)};a.sendPrivateMsg=function(e,f){this.sendMsg("PRIVMSG "+e+" :"+f)};a.sendChannelAction=function(g,f){var e=String.fromCharCode(1);this.sendMsg("PRIVMSG "+g+" :"+e+"ACTION "+f+e)};a.sendPrivateAction=function(e,g){var f=String.fromCharCode(1);this.sendMsg("PRIVMSG "+e+" :"+f+"ACTION "+g+f)};a.sendChannelNotice=function(f,e){this.sendMsg("NOTICE "+f+" :"+e)};a.sendPrivateNotice=function(e,f){this.sendMsg("NOTICE "+e+" :"+f)};a.renameNick=function(e,f){$.each(a.state.channels,function(g,h){if(h.members[e]!==undefined){h.members[f]=h.members[e];h.removeMember(e)}});a.state.users[f]=a.state.users[e];a.state.removeUser(e);a.state.isModified=true};a.stricmp=function(f,e){return f.toLocaleLowerCase().localeCompare(e.toLocaleLowerCase())};a.isChannel=function(e){return e.match(/^[#&+!][^\s,:\cg]+/)}};(function(){var b={};var a={layouts:function(){return b}};var c=function(d){return d===undefined||d===null||d===""};$.chatmore=function(){var e=arguments[0];var d=Array.prototype.slice.call(arguments,1);return a[e].apply(null,d)};$.fn.chatmore=function(){if(arguments.length===0||typeof(arguments[0])==="object"){var i=arguments.length>0?arguments[0]:{};var h={port:6667,title:document.title,viewKey:"",nick:"user"+Math.floor(Math.random()*10000),quitMessage:"Chatmore IRC client",reactivateAttempts:6,reactivateDelay:10,layout:undefined};$.extend(h,i);if(c(h.realname)){h.realname=h.nick}if(typeof(h.channel)==="object"){autoJoinChannels=h.channel}else{if(!c(h.channel)){autoJoinChannels.push(h.channel)}}var d=function(){if(h.layout===undefined){if("default" in b){return b["default"]}else{for(var k in b){if(data.propertyIsEnumerable(prop)){return b[k]}}if(window.console){console.warn("Error initializing Chatmore:  No layout plugins have been loaded!")}return false}}else{return b[h.layout]}};var f={ircElement:$(this),irc:undefined,options:h,autoJoinChannels:[],prevState:undefined,enableAutoReactivate:true,reactivateAttempts:0,isPendingActivation:false,layoutPlugin:d(),cmdDefs:{clear:{helpUsage:"Usage: /clear",helpText:"Clear the chat console.",parseParam:function(){},exec:function(k){f.ircElement.find(".ircConsole .content").html("")}},cleartopic:{helpUsage:"Usage: /cleartopic",helpText:"Clear the selected channel's topic.",parseParam:function(l,k){if(!f.irc.state.isActivated){k.error="Error: Must be connected to clear the topic.";return false}},exec:function(k){f.irc.sendMsg("TOPIC "+f.irc.target()+" :")}},connect:{helpUsage:"Usage: /connect",helpText:"Reconnect after disconnection.",parseParam:function(){},exec:function(k){if(f.isPendingActivation){k.error="Error: Cannot reconnect while connection attempt is pending.  Enter /quit to abort connection attempt.";return false}else{if(f.irc.state.isActivated){k.error="Error: Cannot reconnect while still connected.";return false}}f.irc.activateClient()}},deop:{helpUsage:"Usage: /deop &lt;nick&gt; [nick ...]",helpText:"Revoke channel operator status from a user.",parseParam:function(l,k){if(l===undefined){k.error=f.cmdDefs.deop.helpUsage;return false}k.channel=f.irc.target();k.nicks=l.split(/\s+/);if(c(k.channel)||!f.isChannel(k.channel)){k.error="Error: Must select a channel to revoke operator status.";return false}if(!f.irc.state.isActivated){k.error="Error: Must be connected to revoke operator status.";return false}},exec:function(m){var l=Array(m.nicks.length+1).join("o");var k=m.nicks.join(" ");f.irc.sendMsg("MODE "+m.channel+" -"+l+" "+k)}},devoice:{helpUsage:"Usage: /devoice &lt;nick&gt; [nick ...]",helpText:"Revoke channel voice status from a user.",parseParam:function(l,k){if(l===undefined){k.error=f.cmdDefs.devoice.helpUsage;return false}k.channel=f.irc.target();k.nicks=l.split(/\s+/);if(c(k.channel)||!f.isChannel(k.channel)){k.error="Error: Must select a channel to revoke voice status.";return false}if(!f.irc.state.isActivated){k.error="Error: Must be connected to revoke voice status.";return false}},exec:function(m){var l=Array(m.nicks.length+1).join("v");var k=m.nicks.join(" ");f.irc.sendMsg("MODE "+m.channel+" -"+l+" "+k)}},help:{helpUsage:"Usage: /help &lt;command&gt;",helpText:["Show help for client commands.","Commands:"," clear - Clear the chat console"," cleartopic - Clear the channel's topic (must be an operator)"," connect - Reconnect to IRC server"," join - Join a channel"," kick - Kick user from channel (must be an operator)"," leave - Leave a channel"," list - Get channel listing"," me - Send an action message"," motd - Get the server message of the day"," msg - Send a private message"," nick - Change your nick"," notice - Send a notice to a user or channel"," op/deop - Grant/revoke channel operator status to a user (must be an operator)"," query - Select a target for messaging"," quit - Quit IRC session"," quote - Send raw IRC message"," time - Get the server time"," topic - Get or set the channel's topic (must be an operator)"," voice/devoice - Grant/revoke channel voice to a user (must be an operator)"," who - Get info on a user"],parseParam:function(l,k){if(l===undefined){l="help"}if(f.cmdDefs[l]===undefined){k.error='Error: Cannot get help on unknown command "'+l+'".';return false}k.cmd=l},exec:function(l){var k=f.cmdDefs[l.cmd];f.writeTmpl("help",{message:k.helpUsage});if(typeof(k.helpText)==="object"){$.each(k.helpText,function(m,n){f.writeTmpl("help",{message:n})})}else{f.writeTmpl("help",{message:k.helpText})}}},join:{helpUsage:"Usage: /join &lt;#channel&gt; [key]",helpText:"Join a channel.  Include a key if the channel requires it to join.",parseParam:function(m,k){if(m===undefined){k.error=f.cmdDefs.join.helpUsage;return false}var l=m.split(/\s+/,2);k.channel=l[0].replace(/^([^#&+!])/,"#$1");if(l[1]!==undefined){k.key=l[1]}if(!f.irc.state.isActivated){k.error="Error: Must be connected to join a channel.";return false}},exec:function(k){f.joinChannel(k.channel,k.key)}},kick:{helpUsage:"Usage: /kick &gt;nick&lt; [comment]",helpText:"Kick user from channel.",parseParam:function(o,n){var l=f.cmdDefs.kick.helpUsage;var k=/^(\S+)(\s+(.+))?/.exec(o);if(k===null){n.error=l;return false}n.channel=f.irc.target();n.nick=k[1];n.comment=k[3];if(!f.irc.state.isActivated){n.error="Error: Must be connected to kick a user.";return false}},exec:function(k){if(k.comment!==undefined){f.irc.sendMsg("KICK "+k.channel+" "+k.nick+" :"+k.comment)}else{f.irc.sendMsg("KICK "+k.channel+" "+k.nick)}}},leave:{helpUsage:"Usage: /leave [#channel] [comment]",helpText:["Leave a channel.","If channel omitted, leaves channel currently selected by /query."],parseParam:function(n,l){if(n===undefined){if(f.irc.target()===undefined){l.error=f.cmdDefs.leave.helpUsage;return false}else{l.channel=f.irc.target()}}else{var k=/^(\S+)(\s+(.+))?\s*$/.exec(n);l.channel=k[1].replace(/^([^#&+!])/,"#$1");if(k[3]!==undefined){l.comment=k[3]}}if(!f.irc.state.isActivated){l.error="Error: Must be connected to leave a channel.";return false}},exec:function(k){if(k.comment!==undefined){f.irc.sendMsg("PART "+k.channel+" :"+k.comment)}else{f.irc.sendMsg("PART "+k.channel)}}},list:{helpUsage:"Usage: /list [#channel [, #channel ...] ] [server]",helpText:"Get channel listing.",parseParam:function(n,l){if(n===undefined){}else{var k=/^([#&+!][^\s,:\cg]+(\s*,\s*[#&+!][^\s,:\cg]+)*)(\s+(\S+))?\s*$/.exec(n);if(k!==null){l.channels=k[1].split(/\s*,\s*/);if(k[4]!==undefined){l.server=k[4]}}else{k=/^(\S+)\s*$/.exec(n);if(k!==null){l.server=k[1]}else{l.error=f.cmdDefs.list.helpUsage;return false}}}if(!f.irc.state.isActivated){l.error="Error: Must be connected to get the channel listing.";return false}},exec:function(k){if(k.channels!==undefined){if(k.server!==undefined){f.irc.sendMsg("LIST "+k.channels.join(",")+" "+k.server)}else{f.irc.sendMsg("LIST "+k.channels.join(","))}}else{if(k.server!==undefined){f.irc.sendMsg("LIST "+k.server)}else{f.irc.sendMsg("LIST")}}}},me:{helpUsage:"Usage: /me &lt;message&gt;",helpText:"Send an action message to currently selected channel or user.",parseParam:function(m,l){var k=f.cmdDefs.msg.helpUsage;if(m===undefined){l.error=k;return false}l.target=f.irc.target();l.message=m;if(c(l.target)){l.error="Error: Must select a channel or nick to send a message.";return false}if(!f.irc.state.isActivated){l.error="Error: Must be connected to send an action message.";return false}},exec:function(k){if(f.isChannel(k.target)){f.irc.sendChannelAction(k.target,k.message);f.writeTmpl("outgoingChannelAction",{msg:{prefixNick:f.irc.state.nick,prefixUser:f.irc.state.ident,info:{target:k.target,text:k.message}}})}else{f.irc.sendPrivateAction(k.target,k.message);f.writeTmpl("outgoingPrivateAction",{msg:{prefixNick:f.irc.state.nick,prefixUser:f.irc.state.ident,info:{target:k.target,text:k.message}}})}}},mode:{helpUsage:"Usage: /mode &lt;nick | #channel&gt; [ &lt;+mode | -mode&gt; [parameters] ]",helpText:["Get or change user or channel mode.","Available user modes: http://tools.ietf.org/html/rfc2812#section-3.1.5","Available channel modes: http://tools.ietf.org/html/rfc2811#section-4"],parseParam:function(o,n){var l=f.cmdDefs.mode.helpUsage;var k=/^(\S+)(\s+(\S+(\s+\S+)*))?\s*$/.exec(o);if(k===null){n.error=l;return false}n.target=k[1];if(k[3]!==undefined){n.modes=k[3].split(/\s+/)}if(!f.irc.state.isActivated){n.error="Error: Must be connected to change mode.";return false}},exec:function(k){if(k.modes!==undefined){f.irc.sendMsg("MODE "+k.target+" "+k.modes.join(" "))}else{f.irc.sendMsg("MODE "+k.target)}}},motd:{helpUsage:"Usage: /motd [server]",helpText:["Get the server message of the day.","If server parameter is omitted, query current server."],parseParam:function(l,k){k.server=l;if(!f.irc.state.isActivated){k.error="Error: Must be connected to get server motd.";return false}},exec:function(k){if(k.server!==undefined&&k.server.length>0){f.irc.sendMsg("MOTD "+k.server)}else{f.irc.sendMsg("MOTD")}}},msg:{helpUsage:"Usage: /msg &lt;nick|#channel&gt; &lt;message&gt;",helpText:"Send a private message to a user.",parseParam:function(o,n){var l=f.cmdDefs.msg.helpUsage;if(o===undefined){n.error=l;return false}var k=/^(\S+)\s+(.+)$/.exec(o);if(k===null||k.length!==3){n.error=l;return false}n.target=k[1];n.message=k[2];if(!f.irc.state.isActivated){n.error="Error: Must be connected to send a message.";return false}},exec:function(k){if(f.isChannel(k.target)){f.irc.sendChannelMsg(k.target,k.message);f.writeTmpl("outgoingChannelMsg",{msg:{prefixNick:f.irc.state.nick,prefixUser:f.irc.state.ident,info:{target:k.target,text:k.message}}})}else{f.irc.sendPrivateMsg(k.target,k.message);f.writeTmpl("outgoingPrivateMsg",{msg:{prefixNick:f.irc.state.nick,prefixUser:f.irc.state.ident,info:{target:k.target,text:k.message}}})}}},nick:{helpUsage:"Usage: /nick &lt;nickname&gt;",helpText:"Change your nick.",parseParam:function(m,k){if(m===undefined){k.error=f.cmdDefs.nick.helpUsage;return false}var l=m.split(/\s+/,1);k.nick=l[0];if(!f.irc.state.isActivated){k.error="Error: Must be connected to change your nickname.";return false}},exec:function(k){f.irc.sendMsg("NICK "+k.nick)}},notice:{helpUsage:"Usage: /notice &lt;nick|#channel&gt; &lt;message&gt;",helpText:"Send a notice to a user or channel.",parseParam:function(o,n){var l=f.cmdDefs.msg.helpUsage;if(o===undefined){n.error=l;return false}var k=/^(\S+)\s+(.+)$/.exec(o);if(k===null||k.length!==3){n.error=l;return false}n.target=k[1];n.message=k[2];if(!f.irc.state.isActivated){n.error="Error: Must be connected to send a notice.";return false}},exec:function(k){if(f.isChannel(k.target)){f.irc.sendChannelNotice(k.target,k.message);f.writeTmpl("outgoingChannelNotice",{msg:{prefixNick:f.irc.state.nick,prefixUser:f.irc.state.ident,info:{target:k.target,text:k.message}}})}else{f.irc.sendPrivateNotice(k.target,k.message);f.writeTmpl("outgoingPrivateNotice",{msg:{prefixNick:f.irc.state.nick,prefixUser:f.irc.state.ident,info:{target:k.target,text:k.message}}})}}},op:{helpUsage:"Usage: /op &lt;nick&gt; [nick ...]",helpText:"Grant channel operator status to a user.",parseParam:function(l,k){if(l===undefined){k.error=f.cmdDefs.op.helpUsage;return false}k.channel=f.irc.target();k.nicks=l.split(/\s+/);if(c(k.channel)||!f.isChannel(k.channel)){k.error="Error: Must select a channel to grant operator status.";return false}if(!f.irc.state.isActivated){k.error="Error: Must be connected to grant operator status.";return false}},exec:function(m){var l=Array(m.nicks.length+1).join("o");var k=m.nicks.join(" ");f.irc.sendMsg("MODE "+m.channel+" +"+l+" "+k)}},query:{helpUsage:"Usage: /query &lt;nick|#channel&gt;",helpText:"Select a user or channel to send messages.",parseParam:function(m,k){if(m===undefined){k.error=f.cmdDefs.query.helpUsage;return false}var l=m.split(/\s+/,1);k.target=l[0];if(!f.irc.state.isActivated){k.error="Error: Must be connected to query a target.";return false}},exec:function(k){f.queryTarget(k.target)}},quit:{helpUsage:"Usage: /quit [comment]",helpText:"Quit IRC session.",parseParam:function(l,k){k.comment=l;if(!f.irc.state.isActivated&&!f.isPendingActivation){k.error="Error: Must be connected to quit.";return false}},exec:function(k){if(f.irc.target()!==undefined){f.queryTarget(undefined)}var l=k.comment!==undefined?k.comment:f.options.quitMessage;f.enableAutoReactivate=false;if(f.isPendingActivation){f.isPendingActivation=false;f.writeTmpl("error",{message:"Server connection aborted."})}else{f.irc.sendMsg("QUIT :"+l)}}},quote:{helpUsage:"Usage: /quote &gt;IRC request message&lt;",helpText:"Send a raw IRC request based on RFC2812.",parseParam:function(l,k){k.param=l;if(!f.irc.state.isActivated){k.error="Error: Must be connected to send a raw IRC request.";return false}if(c(k.param)){k.error="Missing parameter to /quote.";return false}},exec:function(k){f.irc.sendMsg(k.param)}},time:{helpUsage:"Usage: /time [server]",helpText:["Get the server time.","If server parameter is omitted, query current server."],parseParam:function(l,k){k.server=l;if(!f.irc.state.isActivated){k.error="Error: Must be connected to get server time.";return false}},exec:function(k){if(k.server!==undefined&&k.server.length>0){f.irc.sendMsg("TIME "+k.server)}else{f.irc.sendMsg("TIME")}}},topic:{helpUsage:"Usage: /topic [message]",helpText:"Get or set the selected channel's topic",parseParam:function(l,k){k.topic=l;if(f.irc.target()===undefined){k.error="Error: No target selected.  Doubleclick a channel or user on the side bar or enter: /query &lt;nick|#channel&gt;.";return false}if(!f.irc.state.isActivated){k.error="Error: Must be connected to get or set the topic.";return false}},exec:function(k){if(k.topic===undefined){f.irc.sendMsg("TOPIC "+f.irc.target())}else{f.irc.sendMsg("TOPIC "+f.irc.target()+" :"+k.topic)}}},voice:{helpUsage:"Usage: /voice &lt;nick&gt; [nick ...]",helpText:"Grant channel voice status to a user.",parseParam:function(l,k){if(l===undefined){k.error=f.cmdDefs.voice.helpUsage;return false}k.channel=f.irc.target();k.nicks=l.split(/\s+/);if(c(k.channel)||!f.isChannel(k.channel)){k.error="Error: Must select a channel to grant voice status.";return false}if(!f.irc.state.isActivated){k.error="Error: Must be connected to grant voice status.";return false}},exec:function(m){var l=Array(m.nicks.length+1).join("v");var k=m.nicks.join(" ");f.irc.sendMsg("MODE "+m.channel+" +"+l+" "+k)}},who:{helpUsage:"Usage: /who &lt;nick | channel&gt;",helpText:"Get info on a user or all users in a channel.",parseParam:function(l,k){k.target=l;if(!f.irc.state.isActivated){k.error="Error: Must be connected to get WHO information.";return false}if(c(k.target)){k.error="Missing parameter to /quote.";return false}},exec:function(k){f.irc.sendMsg("WHO "+k.target)}}},sendLine:function(q){var k=/^\/(\S+)(\s+(.+))?/.exec(q);if(k){var n=k[1].toLowerCase();var p=k[3];if(f.cmdDefs[n]===undefined){f.writeTmpl("error",{message:'Error: Unknown client command "'+n+'".'})}else{var o={};var l=f.cmdDefs[n];if(l.parseParam&&l.parseParam(p,o)===false){if(o.error){f.writeTmpl("error",{message:o.error})}}else{l.exec(o)}}}else{if(f.irc.state.isActivated){if(f.irc.target()!==undefined){q=q.replace(/([\n\r])/gm,"");if(q.length>0){f.sendLine("/msg "+f.irc.target()+" "+q)}}else{f.writeTmpl("error",{message:"Error: No target selected.  Use: /query <nick|#channel> or /join <#channel>."})}}else{f.writeTmpl("error",{message:"Error: Cannot send message, client not activated."})}}},getShortTimestamp:function(){var k=new Date();return k.getHours()+":"+f.padZero(k.getMinutes(),2)},getLongTimestamp:function(){return new Date().toLocaleString()},padZero:function(o,l){var m=new Array(l+1).join("0");var k=""+m+o;return k.substring(k.length-l)},formatTime:function(k){var l=new Date();l.setTime(k*1000);return l.toLocaleString()},isChannel:function(k){return k.match(/^[#&+!][^\s,:\cg]+/)},stricmp:function(l,k){return l.toLocaleLowerCase().localeCompare(k.toLocaleLowerCase())},writeTmpl:function(k,l){f.layoutPlugin.writeTemplate(f,k,l)},startsWith:function(k,m,l){return k.length>=m.length&&l(k.substr(0,m.length),m)===0},getNextMatch:function(n,k,m){if(n.length>0){if(k===undefined||k===null){return n[0]}for(var l in n){var o=n[l];if(m(o,k)>0){return o}}return n[0]}else{return undefined}},clearSelection:function(){if(window.getSelection){window.getSelection().removeAllRanges()}else{if(document.selection){document.selection.empty()}}},joinChannel:function(l,k){if(f.irc.state.channels[l]!==undefined){f.queryTarget(l)}else{if(k!==undefined){f.irc.sendMsg("JOIN "+l+" "+k)}else{f.irc.sendMsg("JOIN "+l)}}},queryTarget:function(l){if(window.console){console.log("queryTarget("+l+")")}var k=f.irc.target();if(l!==k){f.irc.target(l);f.writeTmpl(l===undefined?"queryOff":"query",{target:l,prevTarget:k});f.ircElement.find(".targetFragment").fadeOut(null,function(){f.ircElement.find(".targetLabel").text(l);if(l!==undefined&&l!==null){var m=f.isChannel(l);f.ircElement.find(".targetLabel").removeClass(m?"nick":"channel").addClass(m?"channel":"nick");f.ircElement.find(".targetFragment").fadeIn()}})}},getJoinedChannels:function(){var k=[];if(f.irc.state!==undefined){k=$.map(f.irc.state.channels,function(m,l){return l})}return k.sort(f.stricmp)},getChannelMembers:function(l){var k=[];if(f.irc.state!==undefined){var m=f.irc.state.channels[l];if(m!==undefined){k=$.map(m.members,function(n,o){return o})}}return k.sort(f.stricmp)},getLength:function(m){if(m.length){return m.length}else{if(Object.keys){return Object.keys(m).length}else{var l=0;for(var k in m){if(m.hasOwnProperty(k)){l++}}return l}}},clone:function(l){var k=(l instanceof Array)?[]:{};for(key in l){k[key]=(l[key]&&typeof l[key]==="object")?f.clone(l[key]):l[key]}return k},methods:{activateClient:function(){f.irc.activateClient();return f.ircElement},deactivateClient:function(){f.irc.deactivateClient();return f.ircElement},resize:function(l,k){f.layoutPlugin.resize(f,l,k);return f.ircElement},scrollToBottom:function(){f.layoutPlugin.scrollToBottom(f);return f.ircElement},isAtBottom:function(){return f.layoutPlugin.isAtBottom(f)},layouts:function(){return b},setLayout:function(k){if(k in b){if(f.layoutPlugin!==undefined){f.layoutPlugin.destroy(f)}f.layoutPlugin=b[k];f.layoutPlugin.initialize(f)}else{if(window.console){console.warn("Attempted to use Chatmore layout that does not exist: "+k)}}},onLocalMessage:function(k){f.ircElement.on("localMessage.chatmore",function(l,m){k.call(f.ircElement,l,m)});return f.ircElement},onStateChanged:function(k){f.ircElement.on("stateChanged.chatmore",function(l){k.call(f.ircElement,l,f.irc.state)});return f.ircElement},onProcessingMessage:function(k){f.ircElement.on("processingMessage.chatmore",function(l,m){k.call(f.ircElement,l,m)});return f.ircElement},onProcessedMessage:function(k){f.ircElement.on("processedMessage.chatmore",function(l,m){k.call(f.ircElement,l,m)});return f.ircElement},onSendingMessage:function(k){f.ircElement.on("sendingMessage.chatmore",function(m,l,n){k.call(f.ircElement,m,l,n)});return f.ircElement},onSentMessage:function(k){f.ircElement.on("sentMessage.chatmore",function(m,l,n){k.call(f.ircElement,m,l,n)});return f.ircElement},onErrorSendingMessage:function(k){f.ircElement.on("errorSendingMessage.chatmore",function(m,o,l,n){k.call(f.ircElement,m,o,l,n)});return f.ircElement},onActivatingClient:function(k){f.ircElement.on("activatingClient.chatmore",function(n,l,m,o){k.call(f.ircElement,n,l,m,o)});return f.ircElement},onDeactivatingClient:function(k){f.ircElement.on("deactivatingClient.chatmore",function(l){k.call(f.ircElement,l)});return f.ircElement}}};f.ircElement.empty().off().data("chatmore",f);f.layoutPlugin.initialize(f);f.cmdDefs.j=f.cmdDefs.join;f.cmdDefs.k=f.cmdDefs.kick;f.cmdDefs.l=f.cmdDefs.leave;f.cmdDefs.m=f.cmdDefs.msg;f.cmdDefs.n=f.cmdDefs.notice;f.cmdDefs.q=f.cmdDefs.query;f.ircElement.on("localMessage.chatmore",function(p,n,l,o){if(window.console){console.log("UI event: localMessage")}switch(o.code){case"R1":f.writeTmpl("retryRegistration",{});break;case"RE1":var k=o.maxRegistrationAttempts>1?"Registration failed.  Unable to register with a unique nickname after "+o.maxRegistrationAttempts+" attempts.  Please reconnect with a unique nickname.":"Registration failed.  Please reconnect with a unique nickname.";f.writeTmpl(l,{message:k});f.enableAutoReactivate=false;f.irc.deactivateClient();break;default:f.writeTmpl(l,{message:n})}f.layoutPlugin.onLocalMessage(f,n,l,o)}).on("processingMessage.chatmore",function(k,l){if(l.type==="recv"){f.irc.state.addUser(l.prefixNick);if(l.command==="433"){f.writeTmpl("nickInUse",{msg:l})}}f.layoutPlugin.onProcessingMessage(f,l)}).on("processedMessage.chatmore",function(l,m){if(m.type==="recv"){switch(m.command){case"PRIVMSG":if(f.stricmp(m.info.target,f.irc.state.nick)===0){f.writeTmpl(m.info.isAction?"incomingPrivateAction":"incomingPrivateMsg",{msg:m})}else{f.writeTmpl(m.info.isAction?"incomingChannelAction":"incomingChannelMsg",{msg:m})}break;case"NOTICE":if(f.stricmp(m.info.target,f.irc.state.nick)===0){f.writeTmpl("incomingPrivateNotice",{msg:m})}else{f.writeTmpl("incomingChannelNotice",{msg:m})}break;case"JOIN":f.writeTmpl("join",{msg:m});if(f.stricmp(m.prefixNick,f.irc.state.nick)===0){f.queryTarget(m.info.channel)}break;case"PART":f.writeTmpl("leave",{msg:m});break;case"KICK":var k=$.extend(true,{},m);delete k.info.kicks;$.each(m.info.kicks,function(n,o){k.info.kick=o;f.writeTmpl("kick",{msg:k})});break;case"MODE":f.writeTmpl("mode",{msg:m});break;case"NICK":f.writeTmpl("nick",{msg:m});if(f.irc.target()!==undefined&&f.stricmp(m.prefixNick,f.irc.target())===0){f.queryTarget(m.info.nick)}break;case"TOPIC":f.writeTmpl("changeTopic",{msg:m});break;case"QUIT":f.writeTmpl("quit",{msg:m});break;case"ERROR":f.writeTmpl("error",{message:m.info.message});break;case"001":if(f.autoJoinChannels!==undefined&&f.autoJoinChannels.length>0){$.each(f.autoJoinChannels.sort(f.stricmp).reverse(),function(n,o){if(window.console){console.log("Joining channel: "+o)}f.irc.sendMsg("JOIN "+o)})}break;case"252":case"253":case"254":f.writeTmpl("serverMsg",{number:m.info.number,message:m.info.message});break;case"322":f.writeTmpl("list",{msg:m});break;case"331":f.writeTmpl("notopic",{msg:m});break;case"332":f.writeTmpl("topic",{msg:m});break;case"333":f.writeTmpl("topicSetBy",{msg:m});break;case"352":f.writeTmpl("who",{msg:m});break;case"391":f.writeTmpl("serverTime",{msg:m});break;case"403":f.writeTmpl("serverMsg",{message:m.info.message});break;case"477":f.writeTmpl("serverMsg",{channel:m.info.channel,message:m.info.message});break;case"004":case"005":case"323":case"324":case"353":case"366":case"433":break;default:if(m.info.message!==undefined){f.writeTmpl("serverMsg",{message:m.info.message})}break}}f.layoutPlugin.onProcessedMessage(f,m)}).on("stateChanged.chatmore",function(o){if(window.console){console.log("UI event: stateChanged");console.log(f.irc.state)}var m=f.irc.state;if(f.prevState===undefined||f.stricmp(m.nick,f.prevState.nick)!==0){if(window.console){console.log("Nick changed.")}var k=f.ircElement.find(".nickLabel");k.fadeOut(null,function(){k.text(m.nick);k.fadeIn()})}var n=f.irc.target();if(n!==undefined){var p=f.isChannel(n);if(p&&!(n in m.channels)){var l=f.getJoinedChannels()[0];if(window.console){console.log("Selected channel is no longer joined.  Selecting first channel: "+l)}f.queryTarget(l)}else{if(!p&&!(n in m.users)){var l=f.getJoinedChannels()[0];if(window.console){console.log("Selected user is no longer available.  Selecting first channel: "+l)}f.queryTarget(l)}}}f.layoutPlugin.onStateChanged(f);f.prevState=f.clone(f.irc.state)}).on("sendingMessage.chatmore",function(l,k,m){f.layoutPlugin.onSendingMessage(f,k,m)}).on("errorSendingMessage.chatmore",function(l,n,k,m){if(window.console){console.warn("Error sending message: "+k+", resendCount: "+m);console.warn(n)}f.layoutPlugin.onErrorSendingMessage(f,n,k,m);if(m==f.irc.options.maxResendAttempts){f.writeTmpl("error",{message:"Unable to send message: "+k})}else{if(m==2){f.writeTmpl("error",{message:"Error sending message to server, will try again: "+k})}}}).on("activatingClient.chatmore",function(o,l,m,p){switch(l){case"start":if(window.console){console.log("UI event: activatingClient start")}f.isPendingActivation=true;f.ircElement.find(".userEntry").focus();break;case"connecting":if(window.console){console.log("UI event: activatingClient connecting")}var n=p.server+(p.port!=6667?(":"+p.port):"");f.writeTmpl("clientMsg",{message:"Connecting to IRC server "+n});break;case"resuming":if(window.console){console.log("UI event: activatingClient resuming")}var n=p.server+(p.port!=6667?(":"+p.port):"");f.writeTmpl("clientMsg",{message:"Resuming existing IRC connection to "+n});var k=f.autoJoinChannels.sort(f.stricmp);if(k.length>0){$.each(k,function(q,r){if(window.console){console.log("Rejoining channel: "+r)}f.irc.sendMsg("JOIN "+r);f.irc.sendMsg("NAMES "+r)});f.queryTarget(k[0])}break;case"activated":if(window.console){console.log("UI event: activatingClient activated")}f.ircElement.removeClass("deactivated").addClass("activated");f.reactivateAttempts=0;f.enableAutoReactivate=true;f.isPendingActivation=false;break;case"error":if(window.console){console.log("UI event: activatingClient error")}f.isPendingActivation=false;f.writeTmpl("error",{message:m});break}f.layoutPlugin.onActivatingClient(f,l,m,p)}).on("deactivatingClient.chatmore",function(){if(window.console){console.log("UI event: deactivatingClient")}f.ircElement.removeClass("activated").addClass("deactivated");if(f.enableAutoReactivate){if(f.reactivateAttempts<f.options.reactivateAttempts){f.isPendingActivation=true;f.writeTmpl("error",{message:"Server connection lost.  Retrying connection in "+f.options.reactivateDelay+" seconds...  Enter /quit to abort."});setTimeout(function(){if(f.enableAutoReactivate){f.reactivateAttempts++;f.irc.activateClient()}},f.options.reactivateDelay*1000)}else{f.isPendingActivation=false;f.writeTmpl("error",{message:"Server connection lost and will not reconnect.  Sorry about that."})}}else{f.isPendingActivation=false;f.writeTmpl("error",{message:"Server connection closed."})}f.layoutPlugin.onDeactivatingClient(f)});$.each(["onStateChanged","onLocalMessage","onProcessingMessage","onProcessedMessage","onSendingMessage","onErrorSendingMessage","onSentMessage","onActivatingClient","onDeactivatingClient"],function(k,l){if(l in h){f.ircElement.chatmore(l,h[l])}});f.irc=new chatmore(f.ircElement[0],h);if(h.activateImmediately){f.irc.activateClient()}return f.ircElement}else{var j=arguments[0];var g=Array.prototype.slice.call(arguments,1);var e=$(this).data("chatmore");return e.methods[j].apply(e,g)}}})();(function(){var H;var c={title:"<span>{{if messageCount == 1}}A new message has arrived! -- {{else messageCount > 1}}${messageCount} new messages have arrived! -- {{/if}}${self.options.title} - ${self.irc.state.server}:${self.irc.state.port}</span>",timestamp:'<span class="timestamp" title="${self.getLongTimestamp()}">[${self.getShortTimestamp()}]&nbsp;</span>',bullet:"&bull;&bull;&bull;",notePrefix:'<span class="prefix">{{tmpl "bullet"}}</span>',error:'{{tmpl "timestamp"}}<span class="ERROR">{{tmpl "notePrefix"}} <span class="message">${message}</span></span>',usage:'{{tmpl "timestamp"}}<span class="usage">{{tmpl "notePrefix"}} <span class="message">${message}</span></span>',help:'{{tmpl "timestamp"}}<span class="help">{{tmpl "notePrefix"}} <span class="message">${message}</span></span>',serverMsg:'{{tmpl "timestamp"}}<span class="serverMsg">{{tmpl "notePrefix"}} {{if channel}}&lt;<span class="channel">${channel}</span>&gt; {{/if}}<span class="message">{{if number}}${number} {{/if}}${message}</span></span>',clientMsg:'{{tmpl "timestamp"}}<span class="clientMsg">{{tmpl "notePrefix"}} <span class="message">${message}</span></span>',outgoingChannelMsg:'{{tmpl "timestamp"}}<span class="channelMsg"><span class="prefix">&lt;<span class="channel">${msg.info.target}</span>:<span class="nick ${layout.getColorizeCSSClass(self, msg.prefixNick, msg.info.target)}">${msg.prefixNick}</span>&gt;</span> <span class="message">${msg.info.text}</span></span>',outgoingChannelAction:'{{tmpl "timestamp"}}<span class="channelMsg action"><span class="prefix">&lt;<span class="channel">${msg.info.target}</span>&gt; &bull; <span class="nick ${layout.getColorizeCSSClass(self, msg.prefixNick, msg.info.target)}">${msg.prefixNick}</span></span> <span class="message">${msg.info.text}</span></span>',outgoingChannelNotice:'{{tmpl "timestamp"}}<span class="channelNotice outgoing"><span class="prefix">-<span class="channel">${msg.info.target}</span>:<span class="nick ${layout.getColorizeCSSClass(self, msg.prefixNick, msg.info.target)}">${msg.prefixNick}</span>-</span> <span class="message">${msg.info.text}</span></span>',outgoingPrivateMsg:'{{tmpl "timestamp"}}<span class="privateMsg outgoing"><span class="prefix">&bull;<span class="nick">${msg.info.target}</span>&bull;</span> <span class="message">${msg.info.text}</span></span>',outgoingPrivateAction:'{{tmpl "timestamp"}}<span class="privateMsg outgoing action"><span class="prefix">&bull;<span class="nick">${msg.info.target}</span>&bull; <span class="nick">${msg.prefixNick}</span></span> <span class="message">${msg.info.text}</span></span>',outgoingPrivateNotice:'{{tmpl "timestamp"}}<span class="privateNotice outgoing"><span class="prefix">-<span class="nick">${msg.info.target}</span>-</span> <span class="message">${msg.info.text}</span></span>',incomingChannelMsg:'{{tmpl "timestamp"}}<span class="channelMsg"><span class="prefix">&lt;<span class="channel">${msg.info.target}</span>:<span class="nick ${layout.getColorizeCSSClass(self, msg.prefixNick, msg.info.target)}">${msg.prefixNick}</span>&gt;</span> <span class="message">${msg.info.text}</span></span>',incomingChannelAction:'{{tmpl "timestamp"}}<span class="channelMsg action"><span class="prefix">&lt;<span class="channel">${msg.info.target}</span>&gt; &bull; <span class="nick ${layout.getColorizeCSSClass(self, msg.prefixNick, msg.info.target)}">${msg.prefixNick}</span></span> <span class="message">${msg.info.text}</span></span>',incomingChannelNotice:'{{tmpl "timestamp"}}<span class="channelNotice incoming"><span class="prefix">-<span class="channel">${msg.info.target}</span>:<span class="nick ${layout.getColorizeCSSClass(self, msg.prefixNick, msg.info.target)}">${msg.prefixNick}</span>-</span> <span class="message">${msg.info.text}</span></span>',incomingPrivateMsg:'{{tmpl "timestamp"}}<span class="privateMsg incoming"><span class="prefix">&bull;<span class="nick">${msg.prefixNick}</span>&bull;</span> <span class="message">${msg.info.text}</span></span>',incomingPrivateAction:'{{tmpl "timestamp"}}<span class="privateMsg incoming action"><span class="prefix">&bull; <span class="nick">${msg.prefixNick}</span></span> <span class="message">${msg.info.text}</span></span>',incomingPrivateNotice:'{{tmpl "timestamp"}}<span class="privateNotice incoming"><span class="prefix">-<span class="nick">${msg.prefixNick}</span>-</span> <span class="message">${msg.info.text}</span></span>',queryOff:'{{tmpl "timestamp"}}<span class="queryMsg">{{tmpl "notePrefix"}} <span class="message">{{if self.isChannel(prevTarget)}}You are no longer talking on channel <span class="channel">${prevTarget}</span>{{else}}Ending conversation with <span class="nick">${prevTarget}</span>{{/if}}</span></span>',query:'{{tmpl "timestamp"}}<span class="queryMsg">{{tmpl "notePrefix"}} <span class="message">{{if self.isChannel(target)}}You are now talking on channel <span class="channel">${target}</span>{{else}}Starting conversation with <span class="nick">${target}</span>{{/if}}</span></span>',join:'{{tmpl "timestamp"}}<span class="JOIN"><span class="prefix">&lt;<span class="channel">${msg.info.channel}</span>&gt;</span> <span class="message"><span class="nick ${layout.getColorizeCSSClass(self, msg.prefixNick, msg.info.channel)}">${msg.prefixNick}</span> (${msg.prefixUser}@${msg.prefixHost}) has joined the channel</span></span>',leave:'{{tmpl "timestamp"}}<span class="PART"><span class="prefix">{{tmpl "bullet"}} &lt;<span class="channel">${msg.info.channel}</span>&gt;</span> <span class="message"><span class="nick ${layout.getColorizeCSSClass(self, msg.prefixNick, msg.info.channel)}">${msg.prefixNick}</span> has left the channel{{if !!msg.info.comment}}: ${msg.info.comment}{{/if}}</span></span>',kick:'{{tmpl "timestamp"}}<span class="KICK"><span class="prefix">{{tmpl "bullet"}} &lt;<span class="channel">${msg.info.kick.channel}</span>&gt;</span> <span class="message">{{if self.stricmp(self.irc.state.nick, msg.info.kick.nick) === 0}}You have been kicked from the channel by <span class="nick ${layout.getColorizeCSSClass(self, msg.prefixNick, msg.info.kick.channel)}">${msg.prefixNick}</span>{{else}}<span class="nick ${layout.getColorizeCSSClass(self, msg.info.kick.nick, msg.info.kick.channel)}">${msg.info.kick.nick}</span> has been kicked from the channel by <span class="nick ${layout.getColorizeCSSClass(self, msg.prefixNick, msg.info.kick.channel)}">${msg.prefixNick}</span>{{/if}}{{if msg.info.comment !== undefined && msg.info.comment !== msg.prefixNick}}: ${msg.info.comment}{{/if}}</span></span>',nick:'{{tmpl "timestamp"}}<span class="NICK">{{tmpl "notePrefix"}} <span class="message">{{if self.stricmp(self.irc.state.nick, msg.prefixNick) === 0}}Nick changed to <span class="nick">${msg.info.nick}</span>{{else}}<span class="nick">${msg.prefixNick}</span> is now known as <span class="nick">${msg.info.nick}</span>{{/if}}</span></span>',nickInUse:'{{tmpl "timestamp"}}<span class="serverMsg">{{tmpl "notePrefix"}} <span class="message">Nickname <span class="nick">${msg.info.nick}</span> is already in use.</span></span>',notopic:'{{tmpl "timestamp"}}<span class="TOPIC"><span class="prefix">{{tmpl "bullet"}} &lt;<span class="channel">${msg.info.channel}</span>&gt;</span> <span class="message no-decorate">No topic is set</span></span>',topic:'{{tmpl "timestamp"}}<span class="TOPIC"><span class="prefix">{{tmpl "bullet"}} &lt;<span class="channel">${msg.info.channel}</span>&gt;</span> <span class="message">{{if msg.info.topic !== undefined}}<span class="no-decorate">The current topic is:</span> <span class="topicMessage">${msg.info.topic}</span>{{else}}<span class="message no-decorate">No topic is set</span>{{/if}}</span></span>',changeTopic:'{{tmpl "timestamp"}}<span class="TOPIC"><span class="prefix">{{tmpl "bullet"}} &lt;<span class="channel">${msg.info.channel}</span>&gt;</span> <span class="message"><span class="no-decorate"><span class="nick ${layout.getColorizeCSSClass(self, msg.prefixNick, msg.info.channel)}">${msg.prefixNick}</span> {{if msg.info.topic == ""}}has cleared the topic</span>{{else}}has changed the topic to: </span><span class="topicMessage">${msg.info.topic}</span>{{/if}}</span></span>',topicSetBy:'{{tmpl "timestamp"}}<span class="TOPIC"><span class="prefix">{{tmpl "bullet"}} &lt;<span class="channel">${msg.info.channel}</span>&gt;</span> <span class="message no-decorate">Topic set by <span class="nick ${layout.getColorizeCSSClass(self, msg.info.nick, msg.info.channel)}">${msg.info.nick}</span> on <span class="time">${self.formatTime(msg.info.time)}</span></span></span>',who:'{{tmpl "timestamp"}}<span class="WHO">{{tmpl "notePrefix"}} <span class="message">WHO for <span class="nick ${layout.getColorizeCSSClass(self, msg.info.nick, msg.info.channel)}">${msg.info.nick}</span>: "${msg.info.realname}" ${msg.info.user}@${msg.info.host} on server ${msg.info.server}</span>',serverTime:'{{tmpl "timestamp"}}<span class="TIME">{{tmpl "notePrefix"}} <span class="message">Server time for <span class="server">${msg.info.server}</span>: <span class="time">${msg.info.timeString}</span></span></span>',quit:'{{tmpl "timestamp"}}<span class="QUIT">{{tmpl "notePrefix"}} <span class="message">Signoff: <span class="nick">${msg.prefixNick}</span> (${msg.info.message})</span></span>',mode:'{{tmpl "timestamp"}}<span class="MODE">{{tmpl "notePrefix"}} <span class="message">Mode change "<span class="modeString">${msg.info.mode}</span>" for {{if self.isChannel(msg.info.target)}}channel <span class="channel">${msg.info.target}</span> by <span class="nick ${layout.getColorizeCSSClass(self, msg.prefixNick, msg.info.target)}">${msg.prefixNick}</span></span>{{else}}user <span class="nick">${msg.info.target}</span> by <span class="nick">${msg.prefixNick}</span></span>{{/if}}</span>',list:'{{tmpl "timestamp"}}<span class="LIST">{{tmpl "notePrefix"}} <span class="message"><span class="no-decorate"><span class="channel">${msg.info.channel}</span> (${msg.info.memberCount}): </span>${msg.info.topic}</span></span>',retryRegistration:'{{tmpl "timestamp"}}<span class="clientMsg">{{tmpl "notePrefix"}} <span class="message no-decorate">Retrying registration with nickname <span class="nick">${self.irc.state.nick}</span></span></span>'};var r=/\b([a-z]{2,8}:\/\/([\w\-_]+(\.[\w\-_]+)*)(:\d+)?(\/[^\s\?\/<>]*)*(\?\&*([^\s=&#<>]+(=[^\s=&#<>]*)?(&[^\s=&#<>]+(=[^\s=&#<>]*)?)*)?)?(#\S+)?)/gi;var M=[];var I;var u;var x;var k;var f;var C;var i;var n;var a;var S=[""];var F;var m=function(V,Y){H.messageCount++;q(V);var aa=V.ircElement.find(".ircConsole .content");var W;var Z=function(ad){var ae=H.isAtBottom(V);for(var ab=aa.find(".line").length;ab>=V.options.maximumConsoleLines;ab--){aa.find(".line").first().remove()}var ag=ad.find(".prefix .channel").text();ad.closest(".channelMsg,.privateMsg,.TOPIC,.LIST,.serverMsg,.clientMsg").find(".message").each(function(){y(this);p(this);E(V,this,ag)});ad.find(".nick,.channel").hover(w,L).dblclick(function(){A.call(this,V)});ad.closest(".channelMsg").find(".message .nick").filter(function(){return V.irc.state!==undefined&&V.stricmp($(this).text(),V.irc.state.nick)===0}).first().filter(function(){var ah=ad.find(".prefix .nick").text();return V.irc.state!==undefined&&V.stricmp(ah,V.irc.state.nick)!==0}).each(function(){ad.closest(".channelMsg").addClass("nickHighlight")});var ac=$('<div class="line"/>').attr("mc",H.messageCount).append(ad).appendTo(aa);if(!H.isWindowFocused){if(H.blurMessageCount===(H.messageCount-1)){var af=V.ircElement.find(".ircConsole .content");af.find(".line.viewed").removeClass("viewed")}ac.addClass("new").css("opacity","0.5")}if(ae){H.scrollToBottom(V)}return ac};if(typeof(Y)==="object"){$.each(Y,function(ad,ac){var ab=$("<div/>").append(ac);W=Z(ab.contents())})}else{var X=$("<div/>").append(Y);W=Z(X.contents())}return W};var l=function(W){var V=$();$(W).contents().each(function(){if(this.nodeType===3){V=V.add(this)}else{V=V.add(l(this))}});return V};var B=function(V){return l(V).filter(function(){var W=$(this);return $(this).parents(".no-decorate").length===0})};var y=function(V){B(V).each(function(){var W=$(this);var Y=false;var Z=W.text().replace(r,function(ac,ad){Y=true;trailingText=ad.match(/[)>,\.;:'"]$/);if(trailingText!==null){ad=ad.substring(ad,ad.length-trailingText[0].length)}var ae=$("<div/>").append($("<a/>").attr("href",ad).attr("target","_blank").attr("class","no-decorate").text(ad));if(trailingText!==null){ae.append(document.createTextNode(trailingText[0]))}return ae.html()});if(Y){var ab=W.prev();var aa=W.parent();var X=$("<span>"+Z+"</span>");W.remove();if(ab.length){ab.after(X)}else{aa.prepend(X)}}})};var E=function(V,Z,aa){var X;if(V.irc.state!==undefined){X=$.map(V.irc.state.users,function(ac,ab){return ab})}if(X===undefined||X.length===0){return}var W=$.map(X,function(ab){return ab.replace(/([?*|.\^$()\[\]{}\\\/])/g,"\\$1")}).join("|");var Y=new RegExp("\\b("+W+")\\b","ig");B(Z).each(function(){var ab=$(this);var ad=false;var ae=ab.text().replace(Y,function(ai,ah){var aj;if(aa!==undefined&&V.isChannel(aa)){if(V.irc.state.channels[aa]!==undefined&&V.irc.state.channels[aa].members[ah]!==undefined){aj=V.irc.state.channels[aa].members[ah].colorizeNumber}}ad=true;if(aj!==undefined){return'<span class="nick color'+aj+' no-decorate">'+ah+"</span>"}else{return'<span class="nick no-decorate">'+ah+"</span>"}});if(ad){var ag=ab.prev();var af=ab.parent();var ac=$("<span>"+ae+"</span>");ab.remove();if(ag.length){ag.after(ac)}else{af.prepend(ac)}}})};var p=function(V){B(V).each(function(){var W=$(this);var Y=false;var Z=W.text().replace(/(^|[\s,:\cg])(#[^\s,:\cg]+)\b/g,function(ac,ae,ad){Y=true;return ae+'<span class="channel no-decorate">'+ad+"</span>"});if(Y){var ab=W.prev();var aa=W.parent();var X=$("<span>"+Z+"</span>");W.remove();if(ab.length){ab.after(X)}else{aa.prepend(X)}}})};var o=function(W,V,X){var Y=W.irc.state.channels[X];if(Y===undefined){return}return Y.members[V]!==undefined?Y.members[V].colorizeNumber:undefined};var d=function(W,V){if(W.stricmp(V,W.irc.state.nick)!==0){M=$.grep(M,function(X){return W.stricmp(X,V)!==0});M.unshift(V);if(I!==undefined){I++}}};var v=function(V){if(I!==undefined){I=undefined;V.ircElement.find(".userEntry").tooltip("option","content","").tooltip("close")}};var z=function(V){if(I!==undefined){I=undefined;V.ircElement.find(".userEntry").val("").tooltip("option","content","").tooltip("close")}};var h=function(V){var X=V.ircElement.find(".userEntry").first();var Y=X.val();if(Y===""||I!==undefined){if(M.length){if(I===undefined){I=0}var Z=M[I];var W="/msg "+Z+" ";X.val(W);X[0].selectionStart=X[0].selectionEnd=W.length;I++;if(I>=M.length){I=0}X.tooltip("close").tooltip("option","content",'Reply to <span class="activeSuggestion term"><span class="nick">'+Z+"</span></span>").tooltip("open")}}};var R=function(V){g();u=setTimeout(function(){u=undefined;s(V)},200)};var g=function(){if(u!==undefined){clearTimeout(u);u=undefined}};var s=function(ad){var V=ad.ircElement.find(".userEntry").first();var ac=V.val();var Z=V[0].selectionStart;var X=[];if(Z>0){var ae=ac.substr(0,Z);var Y=/([^\s,\.\/\\]+)$/.exec(ae);var ab=ac.substr(Z);if(Y!==null&&/^([\s,\.\/\\]|$)/.test(ab)){i=C=Y[1];n=Z-i.length;var W=C.toLowerCase();var aa=ad.irc.state.channels[ad.irc.target()];if(aa!==undefined){$.each(aa.members,function(af){if(W===af.substr(0,W.length).toLowerCase()&&af!==ad.irc.state.nick){X.push({type:"nick",value:af})}})}$.each(ad.irc.state.channels,function(af){if(W===af.substr(0,W.length).toLowerCase()){X.push({type:"channel",value:af})}})}}if(X.length===0){G(ad)}else{X.sort(function(ag,af){return ag.value.localeCompare(af.value)});if(window.console){console.log("autoComplete matches:");console.log(X)}x=X;k=0;f=undefined;O(ad);k=-1}};var O=function(ac){var V=ac.ircElement.find(".userEntry").first();if(x.length>0){var ad=[];for(var W=0;W<x.length;W++){var Z=(W)%x.length;var X=x[Z];var Y=$("<span />").text(X.value).html();if(X.type==="nick"){var aa=o(ac,X.value,ac.irc.target());Y='<span class="nick color'+aa+'">'+Y+"</span>"}else{if(X.type==="channel"){Y='<span class="channel">'+Y+"</span>"}}if(f!==undefined&&X.value===x[f].value){Y='<span class="activeSuggestion term">'+Y+"</span>"}else{Y='<span class="inactiveSuggestion term">'+Y+"</span>"}ad.push(Y)}var ab=ad.join(",&nbsp;");V.tooltip("option","content",ab).tooltip("open");a(f)}else{V.tooltip("option","content","").tooltip("close")}};var J=function(W,Z){if(x!==undefined){if(Z===undefined){Z=1}var X=W.ircElement.find(".userEntry").first();var aa=X.val();var V=aa.substr(0,n);var Y=aa.substr(n+C.length);k=f=(k+Z)%x.length;C=x[k].value;if(V.length===0){C+=": "}var ab=V+C+Y;X.val(ab);X[0].selectionStart=X[0].selectionEnd=n+C.length;O(W)}};var b=function(W){var X=W.ircElement.find(".userEntry").first();if(C!==undefined){var Z=X.val();var V=Z.substr(0,n);var Y=Z.substr(n+C.length);var aa=V+i+Y;X.val(aa);X[0].selectionStart=X[0].selectionEnd=n+i.length}x=undefined;k=undefined;f=undefined;n=undefined;C=undefined;X.tooltip("option","content","").tooltip("close")};var G=function(V){var W=V.ircElement.find(".userEntry").first();Q();W.tooltip("option","content","").tooltip("close")};var Q=function(){x=undefined;k=undefined;f=undefined;n=undefined;C=undefined};var w=function(){$(this).addClass("ui-state-hover")};var L=function(){$(this).removeClass("ui-state-hover")};var A=function(V){if(V.irc.state.isActivated){var W=$(this).clone().children().remove().end().text();V.clearSelection();if(V.irc.state!==undefined&&V.stricmp(W,V.irc.state.nick)!==0){if(V.isChannel(W)){if(V.irc.state!==undefined&&V.irc.state.channels[W]===undefined){V.sendLine("/join "+W)}else{V.queryTarget(W)}}else{V.queryTarget(W)}V.ircElement.find(".userEntry").focus()}}};var N=function(V){if(!H.freezeSideBar){var W=V.ircElement.find(".sideBar ul.channelList");var X=W[0].scrollTop;W.empty();$.each(V.getJoinedChannels(),function(aa,ab){var ac=V.irc.state.channels[ab];var Z=V.getLength(ac.members);var Y=$('<li><span class="channel">'+ab+'</span><span class="memberCount">('+Z+')</span><span class="leaveButton" title="Leave channel"></span></li>').find(".channel").attr("title",(ac.topic!==undefined)?ac.topic:"No topic set").end().find(".leaveButton").click(function(){if(V.irc.state.isActivated){$(this).parent("li").addClass("leaving");V.sendLine("/leave "+ab)}}).end().appendTo(W);var ad=$('<ul class="memberList"/>').appendTo(Y);$.each(V.getChannelMembers(ab),function(af,ah){var ae=ac.members[ah];var ag=ae.colorizeNumber;$('<li><span class="mode">'+ae.mode+'</span><span class="nick color'+ag+'">'+ah+"</span></li>").appendTo(ad)})});W[0].scrollTop=X;W.find(".nick,.channel").hover(w,L).dblclick(function(){A.call(this,V)})}};var t=function(X){var Z=X.ircElement.find(".ircConsole");var ac=X.ircElement.find(".ircConsole .content");var W=X.ircElement.find(".userEntrySection");var V=X.ircElement.find(".userEntryLine");var ab=X.ircElement.find(".userEntry");var Y=X.ircElement.find(".sideBar");var aa=Y.find(".channelList");ac.width(Z.width()).height(Z.height());W.outerWidth(Z.outerWidth());V.width(W.width());ab.outerWidth(V.width());Y.outerHeight(Z.outerHeight()+W.outerHeight());aa.height(Y.height())};var j=function(){$.each(c,function(W,V){$.template(W,V)})};var D=function(V){var W=$.tmpl("title",{self:V,layout:H,messageCount:H.notificationMessageCount}).text();if(W!==document.title){document.title=W}};var q=function(V){if(!H.isWindowFocused){H.notificationMessageCount++;D(V)}};var K=function(){var V=document.location.hash.split(",");if(V[0].length===0){return[]}else{return V}};var U=function(V){var W=V.sort().join(",");if(document.location.hash!==W){document.location.hash=W}};var T=function(){return Math.random().toString(36).substr(2,8)};var e=function(){return location.search.substring(1)};var P=function(Y){var W={};var X=/([^&=]+)=([^&]*)/g;var V;while(V=X.exec(Y)){W[decodeURIComponent(V[1])]=decodeURIComponent(V[2])}return W};toQueryString=function(V){var W=$.map(V,function(Y,X){if(Y===undefined||Y===null){return encodeURIComponent(X)}else{return encodeURIComponent(X)+"="+encodeURIComponent(Y)}});return W.join("&")};H={messageCount:0,notificationMessageCount:0,blurMessageCount:undefined,isWindowFocused:true,freezeSideBar:false,warnOnUnload:true,initialize:function(W,X){W.ircElement.addClass("chatmore").addClass("-fullpage-layout").addClass("ui-widget").append($('<div style="float:left;overflow:hidden"><div class="ircConsole ui-widget-content ui-corner-tl"><div class="content ui-corner-all"/></div><div class="userEntrySection ui-widget-content ui-corner-bl"><div class="userEntryModeLine"><div class="activationIndicator"/><div class="nickLabel nick"/><div class="targetFragment" style="display:none"><div class="targetLabel"/></div></div><div class="userEntryLine"><input type="text" class="userEntry" /></div></div></div><div class="sideBar ui-widget ui-widget-content ui-corner-right"><ul class="channelList"/></div>'));t(W);j(W);var V=K();if(V.length>0){W.autoJoinChannels=V}$(window).on("focus.chatmore_default",function(){setTimeout(function(){H.notificationMessageCount=0;D(W)},200);if(!H.isWindowFocused){H.isWindowFocused=true;W.ircElement.find(".userEntry").focus();if(H.blurMessageCount){var Z=W.ircElement.find(".ircConsole .content > .line.new");Z.fadeTo(2000,1,"easeOutExpo",function(){Z.removeClass("new").addClass("viewed")})}H.blurMessageCount=undefined}}).on("blur.chatmore_default",function(){H.isWindowFocused=false;H.blurMessageCount=H.messageCount}).on("resize.chatmore_default",function(){H.resize(W)}).on("beforeunload.chatmore_default",function(){if(H.warnOnUnload){return"You are about to navigate away from the Chatmore IRC client, which may disconnect from your session."}});var Y=false;W.ircElement.find(".userEntry").keydown(function(ab){var Z=$(this);Y=false;if(!ab.altKey&&!ab.ctrlKey&&!ab.shiftKey){g();if(ab.keyCode===13){S.unshift("");W.sendLine(Z.val());Z.val("");W.userEntryHistoryIndex=undefined;if(I!==undefined){z(W)}else{G(W)}Y=true;return false}else{if(ab.keyCode===27){if(I!==undefined){z(W)}else{b(W)}Y=true;return false}else{if(ab.keyCode==8||ab.keyCode==46){if(I!==undefined){z(W);Y=true;return false}R(W)}else{if(ab.keyCode===9){if(Z.val()===""||I!==undefined){h(W)}else{if(x===undefined){s(W);J(W)}else{J(W)}}Y=true;return false}else{if(ab.keyCode===38||ab.keyCode===40){if(F===undefined&&S.length>1){F=0}if(F!==undefined){z(W);G(W);if(ab.keyCode===38){F++;if(F>=S.length){F=0}}else{F--;if(F<0){F=S.length-1}}var aa=S[F];Z.val(aa);this.selectionStart=aa.length;this.selectionEnd=this.selectionStart}Y=true;return false}}}}}}}).keypress(function(aa){if(Y){Y=false;return false}Q();if(I!==undefined){v(W)}var Z=$(this);S[0]=Z.val()+String.fromCharCode(aa.which);R(W)}).tooltip({items:".userEntry",show:{effect:"fade",duration:250},position:{my:"left top",at:"left bottom"},track:false,open:function(aa,Z){Z.tooltip.appendTo(W.ircElement);a=function(ac){var ab=Z.tooltip.find(".term").eq(ac).each(function(){var ad=$(this).offset().left-parseInt($(this).css("margin-left"))-parseInt($(this).css("padding-left"))-Z.tooltip.offset().left-parseInt(Z.tooltip.css("padding-left"))+Z.tooltip.scrollLeft();Z.tooltip.stop().animate({scrollLeft:ad})})}}}).focus();H.resize(W)},destroy:function(){$(window).off(".chatmore_default")},writeTemplate:function(W,V,Y){if(V==="outgoingPrivateMsg"){if(!W.isChannel(Y.msg.info.target)){d(W,Y.msg.info.target)}}Y.self=W;Y.layout=H;var X=$("<div/>").append($.tmpl(V,Y));return m(W,X.html())},resize:function(X,ac,V){if(ac&&V){var Z=X.ircElement.find(".ircConsole");var Y=X.ircElement.find(".sideBar");var W=X.ircElement.find(".userEntrySection");Z.outerWidth(ac-Y.outerWidth()).outerHeight(V-W.outerHeight());t(X)}else{var ab=X.ircElement.parent();var aa=H.isAtBottom(X);H.resize(X,$(window).width()-ab.outerWidth()+ab.width(),$(window).height()-ab.outerHeight()+ab.height());if(aa){H.scrollToBottom(X)}}},scrollToBottom:function(V){var W=V.ircElement.find(".ircConsole .content");W[0].scrollTop=W[0].scrollHeight},isAtBottom:function(V){var W=V.ircElement.find(".ircConsole .content");return(W[0].scrollTop+4)>=(W[0].scrollHeight-W[0].clientHeight)},onStateChanged:function(V){N(V);U(V.irc.state.getChannels())},onLocalMessage:function(V,X,W,Y){},onProcessingMessage:function(V,W){},onProcessedMessage:function(V,Z){if(Z.type==="servermsg"&&Z.code===402){if(window.console){console.warn("Got session deleted error.  Generating new viewKey and reactivating...")}var Y=P(e());Y.viewKey=T();if(window.history.replaceState){var X=document.location.pathname+"?"+toQueryString(Y)+document.location.hash;window.history.replaceState(null,document.title,X);var W=$.extend({},V.options);W.viewKey=Y.viewKey;W.channels=K();$("#chatmore").chatmore(W).chatmore("resize")}else{H.warnOnUnload=false;document.location.search="?"+toQueryString(Y)}}else{switch(Z.command){case"PRIVMSG":if(V.stricmp(Z.info.target,V.irc.state.nick)===0){if(!Z.info.isAction){d(V,Z.prefixNick)}}break;case"NOTICE":if(V.stricmp(Z.info.target,V.irc.state.nick)===0){d(V,Z.prefixNick)}break}}},onSendingMessage:function(V,W){},onErrorSendingMessage:function(V,X,W){},onSentMessage:function(V,W){},onActivatingClient:function(V,W,X,Y){if(W==="resuming"||W==="activated"){H.freezeSideBar=false}},onDeactivatingClient:function(V){if(V.enableAutoReactivate&&V.reactivateAttempts<V.options.reactivateAttempts){H.freezeSideBar=true}else{H.freezeSideBar=false}},getColorizeCSSClass:function(W,V,Y){var X=o(W,V,Y);return X!==undefined?"color"+X:""}};$.chatmore("layouts")["default"]=H})();